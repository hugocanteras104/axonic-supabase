-- ===============================================
-- PARCHE 2: AÃ±adir columnas metadata y total_price
-- Aplica DESPUÃ‰S del PARCHE 1 (full_name â†’ name)
-- ===============================================

BEGIN;

-- ===============================================
-- 1. AÃ±adir columna metadata si no existe
-- ===============================================
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'appointments' 
    AND column_name = 'metadata'
  ) THEN
    ALTER TABLE public.appointments 
    ADD COLUMN metadata jsonb NOT NULL DEFAULT '{}'::jsonb;
    
    RAISE NOTICE 'âœ… Columna metadata aÃ±adida a appointments';
  ELSE
    RAISE NOTICE 'âš ï¸  Columna metadata ya existe en appointments';
  END IF;
END $$;

COMMENT ON COLUMN public.appointments.metadata IS
  'Datos adicionales: confirmaciÃ³n, informaciÃ³n del pago, notas, etc.';

-- ===============================================
-- 2. AÃ±adir columna total_price si no existe
-- ===============================================
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'appointments' 
    AND column_name = 'total_price'
  ) THEN
    ALTER TABLE public.appointments 
    ADD COLUMN total_price numeric(10,2);
    
    RAISE NOTICE 'âœ… Columna total_price aÃ±adida a appointments';
  ELSE
    RAISE NOTICE 'âš ï¸  Columna total_price ya existe en appointments';
  END IF;
END $$;

COMMENT ON COLUMN public.appointments.total_price IS
  'Precio total de la cita (puede diferir de base_price por descuentos/paquetes)';

-- ===============================================
-- 3. Ãndice para bÃºsquedas por metadata
-- ===============================================
CREATE INDEX IF NOT EXISTS idx_appointments_metadata 
  ON public.appointments USING gin(metadata);

COMMIT;

-- ===================================================
-- VERIFICACIÃ“N
-- ===================================================
DO $$
DECLARE
  v_has_metadata boolean;
  v_has_total_price boolean;
BEGIN
  SELECT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'appointments' AND column_name = 'metadata'
  ) INTO v_has_metadata;
  
  SELECT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'appointments' AND column_name = 'total_price'
  ) INTO v_has_total_price;
  
  RAISE NOTICE '';
  RAISE NOTICE 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•';
  RAISE NOTICE 'âœ… PARCHE 2 APLICADO';
  RAISE NOTICE 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•';
  RAISE NOTICE 'Columna metadata:     %', CASE WHEN v_has_metadata THEN 'âœ…' ELSE 'âŒ' END;
  RAISE NOTICE 'Columna total_price:  %', CASE WHEN v_has_total_price THEN 'âœ…' ELSE 'âŒ' END;
  RAISE NOTICE '';
  
  IF v_has_metadata AND v_has_total_price THEN
    RAISE NOTICE 'ğŸ‰ Tabla appointments lista para usar';
  ELSE
    RAISE EXCEPTION 'Error: No se pudieron crear las columnas';
  END IF;
END $$;
